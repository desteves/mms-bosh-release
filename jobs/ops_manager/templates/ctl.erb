#!/bin/bash


RUN_DIR=/var/vcap/sys/run/ops_manager
LOG_DIR=/var/vcap/sys/log/ops_manager
PIDFILE=${RUN_DIR}/pid
OPS_DIR=/var/vcap/store/ops_manager
APP_DIR=/var/vcap/packages/mongodb-mms-4.0.1
APP_NAME="mms-app"
APP_ENV="hosted"
APP_ID="mms"
BASE_PORT="8080"
BASE_SSL_PORT="8443"
JAVA_HOME="${APP_DIR}/jdk"
SYSCONFIG="${APP_DIR}/conf/mms.conf"
MMS_USER=vcap
ENC_KEY_PATH=${APP_DIR}/gen.key
ENC_KEY=<%= properties.ops_manager.enc_key_b64 %>
URI_STR=<%= properties.ops_manager.uri %>
FQDN=localhost
MONGOVERSIONS_DIR="${APP_DIR}/automation_versions_directory"
email=<%= properties.ops_manager.email %>
PATH=${PATH}:${RUN_DIR}:${APP_DIR}/bin

# Note: Most of the start code has been modified from 
# etc_rc.d_init.d_mongodb-mms.service and from the init_scripts
######################## build_opts
build_opts() {
    local opts="$1"
    local arr="${!2}"
    for opt in "${arr[@]}"; do
        opts="${opts} ${opt}"
    done
    echo -n $opts
}

case $1 in
   start)
   mkdir -p ${RUN_DIR} ${LOG_DIR} ${OPS_DIR} ${MONGOVERSIONS_DIR} 
     touch ${ENC_KEY_PATH}
     chown -R vcap:vcap ${RUN_DIR} ${LOG_DIR} ${OPS_DIR} ${APP_DIR}/conf/ ${ENC_KEY_PATH} ${MONGOVERSIONS_DIR}
     echo $$ > ${PIDFILE}
     echo ${ENC_KEY} | base64 -d >  ${ENC_KEY_PATH}
     chmod 600 ${ENC_KEY_PATH}

     ### "Jobs never depend on other jobs." 
 	 ### ^  @http://bosh.io/docs/create-release.html
     ### /giphy angry
     ### :angry:
     ### Conclusion: Relying on PreFlight Checks by mongodb-mms and monit retry
	 ### attempts
     
     sed -e "s|^\(LOG_PATH=\).*|\1${LOG_DIR}|" \
         -e "s|^\(MMS_USER=\).*|\1${MMS_USER}|" \
         -e "s|^\(JAVA_HOME=\).*|\1${JAVA_HOME}|" \
         -e "s|^\(ENC_KEY_PATH=\).*|\1${ENC_KEY_PATH}|" \
         -i.bak ${SYSCONFIG}
    cat <<EOF > ${APP_DIR}/conf/conf-mms.properties
mongo.ssl=false
mongo.mongoUri=${URI_STR}
mms.centralUrl=http://${FQDN}:${BASE_PORT}
mms.backupCentralUrl=http://${FQDN}:8081
mms.fromEmailAddr=$email
mms.replyToEmailAddr=$email
mms.adminEmailAddr=$email
mms.emailDaoClass=com.xgen.svc.core.dao.email.JavaEmailDao
mms.backup.minimumOplogWindowHours=0.01
mms.https.ClientCertificateMode=None
mms.mail.port=25
mms.mail.transport=smtp
mms.mail.hostname=localhost
mms.ignoreInitialUiSetup=true
automation.versions.directory=${MONGOVERSIONS_DIR}
mms.user.invitationOnly=false
EOF
	 ### Stripped from .../init.d/mongodb-mms.service
     # 
     # pushd mongodb-mms
     # source the init-functions, other functions have been copied above the
     # source the mms.conf file
     # case statement.
     [[ -f "${SYSCONFIG}" ]] && . "${SYSCONFIG}"

 	 ######################### preFlightCheck
 	 ${JAVA_HOME}/bin/${APP_NAME} \
      -Dcore.preflight.class=com.xgen.svc.mms.MmsPreFlightCheck \
      -Dlog_path=${LOG_DIR}/ops_manager.stdout \
      -Duser.timezone=GMT     -Dfile.encoding=UTF-8 \
      -Dserver-env=${APP_ENV} -Dapp-id=${APP_ID} -Dmms.keyfile=${ENC_KEY_PATH} \
      -Xmx256m -XX:-OmitStackTraceInFastThrow \
      -classpath ${APP_DIR}/classes/mms.jar:${APP_DIR}/conf:${APP_DIR}/lib/* \
      com.xgen.svc.core.PreFlightCheck \
      >>  ${LOG_DIR}/ops_manager.stdout.log \
      2>> ${LOG_DIR}/ops_manager.stderr.log
 	 if [[ $? != 0 ]]; then
        exit 1
 	 fi
	 ######################### migrate
	 ${JAVA_HOME}/bin/${APP_NAME} \
      -Dmms.migrate=all \
      -Dcore.preflight.class=com.xgen.svc.mms.MmsPreFlightCheck \
      -Dlog_path=${LOG_DIR}/ops_manager.stdout \
      -Duser.timezone=GMT     -Dfile.encoding=UTF-8 \
      -Dserver-env=${APP_ENV} -Dapp-id=${APP_ID} -Dmms.keyfile=${ENC_KEY_PATH} \
      -Xmx256m -XX:-OmitStackTraceInFastThrow \
      -classpath ${APP_DIR}/classes/mms.jar:${APP_DIR}/conf:${APP_DIR}/lib/* \
      com.xgen.svc.common.migration.MigrationRunner \
      >>  ${LOG_DIR}/ops_manager.stdout.log \
      2>> ${LOG_DIR}/ops_manager.stderr.log
 	 if [[ $? != 0 ]]; then
        exit 1
	 fi
 	 ulimit -n 64000 > /dev/null 2>&1
 	 ulimit -u 64000 > /dev/null 2>&1
 	 if ulimit -a | grep -q "\-v)" >/dev/null 2>&1; then
        ulimit -v unlimited > /dev/null 2>&1
	 fi
	 ############################## START
	 opts_array=(
         "-Dlog_path=${LOG_DIR}/ops_manager.stdout"
         "-Duser.timezone=GMT"
         "-Dfile.encoding=UTF-8"
         "-Dsun.net.client.defaultReadTimeout=20000"
         "-Dsun.net.client.defaultConnectTimeout=10000"
         "-Dorg.eclipse.jetty.util.UrlEncoding.charset=UTF-8"
         "-Dorg.eclipse.jetty.server.Request.maxFormContentSize=4194304"
         "-Dserver-env=${APP_ENV}"
         "-Dapp-id=${APP_ID}"
         "-Dbase-port=${BASE_PORT}"
         "-Dbase-ssl-port=${BASE_SSL_PORT}"
         "-Dapp-dir=${APP_DIR}"
         "-Dxgen.webServerReuseAddress=true"
         "-Dmms.keyfile=${ENC_KEY_PATH}"
         "-XX:SurvivorRatio=12"
         "-XX:MaxTenuringThreshold=15"
         "-XX:CMSInitiatingOccupancyFraction=62"
         "-XX:+UseCMSInitiatingOccupancyOnly"
         "-XX:+UseConcMarkSweepGC"
         "-XX:+UseParNewGC"
         "-XX:+UseBiasedLocking"
         "-XX:+CMSParallelRemarkEnabled"
         "-XX:-OmitStackTraceInFastThrow"
         "-classpath ${APP_DIR}/classes/mms.jar:${APP_DIR}/agent:${APP_DIR}/agent/backup:${APP_DIR}/agent/monitoring:${APP_DIR}/agent/automation:${APP_DIR}/data/unit:${APP_DIR}/conf/:${APP_DIR}/lib/*"

 )
     # JAVA_MMS_UI_OPTS empty?? TODO check
 	 jvm_opts=$( build_opts "${JAVA_MMS_UI_OPTS}" opts_array[@] )
 	 jvm_opts_instance="${jvm_opts} -Dinstance-id=0 -Dpid-filename=${PIDFILE}"
 	 exec ${JAVA_HOME}/bin/${APP_NAME} ${jvm_opts_instance} com.xgen.svc.core.ServerMain & \
      >>  ${LOG_DIR}/ops_manager.stdout.log \
      2>> ${LOG_DIR}/ops_manager.stderr.log
     ### This causes monit to PID the mongodb-mms script as opposed to the
     ### process itself, hence the above refractoring
     # exec /var/vcap/packages/mongodb-mms-4.0.1/bin/mongodb-mms start 
     ;;

   stop)
	 kill `cat ${PIDFILE}` 1>/dev/null 2>&1
     pkill mongodb-mms 1>/dev/null 2>&1 
     kill -9 `cat ${PIDFILE}` 1>/dev/null 2>&1 
     rm -f ${PIDFILE}
     ;;

   *)
     echo "Usage: ctl {start|stop}" ;;

esac
